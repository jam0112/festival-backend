require('dotenv').config();
const express = require('express');
const mongoose = require('mongoose');
const session = require('express-session');

const app = express();
const PORT = process.env.PORT || 3000;

// 세션 미들웨어 설정
app.use(session({
    secret: process.env.SESSION_SECRET,
    resave: false,
    saveUninitialized: false,
    cookie: {
        secure: 'auto', // Render 같은 프록시 환경에서 https 자동 감지
        httpOnly: true, // JavaScript에서 쿠키 접근 방지
        maxAge: 1000 * 60 * 60 // 쿠키 유효 기간 (1시간)
    }
}));

// 데이터베이스 연결
mongoose.connect(process.env.DATABASE_URL)
  .then(() => console.log('✅ 데이터베이스에 성공적으로 연결되었습니다.'))
  .catch(e => console.error('❌ 데이터베이스 연결에 실패했습니다:', e));

// ... (모델 정의는 이전과 동일) ...
const Visitor = mongoose.model('Visitor', new mongoose.Schema({
    name: String, number: String, gender: String,
    age_group: String, region: String,
    registeredAt: { type: Date, default: Date.now }
}));

app.use(express.static('public'));
app.use(express.json());

// --- 보안 및 인증 로직 ---

// 1. 관리자 정보 (나중에는 DB에 저장하는 것이 더 안전합니다)
const ADMIN_USER = {
    username: 'admin',
    password: 'password123'
};

// 2. 로그인 상태 확인 미들웨어
const checkAuth = (req, res, next) => {
    if (req.session.isLoggedIn) {
        // 로그인 상태이면 다음 단계로 진행
        next();
    } else {
        // 로그인 상태가 아니면 로그인 페이지로 리다이렉트
        res.redirect('/login.html');
    }
};

// 3. API: 로그인 처리
app.post('/login', (req, res) => {
    const { username, password } = req.body;
    if (username === ADMIN_USER.username && password === ADMIN_USER.password) {
        req.session.isLoggedIn = true; // 세션에 로그인 상태 기록
        res.status(200).json({ message: '로그인 성공' });
    } else {
        res.status(401).json({ message: '사용자 이름 또는 비밀번호가 잘못되었습니다.' });
    }
});

// 4. API: 로그아웃 처리
app.get('/logout', (req, res) => {
    req.session.destroy(err => {
        if (err) {
            return res.status(500).send('로그아웃 실패');
        }
        res.redirect('/login.html');
    });
});

// 5. 관리자 페이지 접근 제어
// '/admin.html' 경로에 접근하기 전에 'checkAuth' 미들웨어가 먼저 실행됩니다.
app.get('/admin.html', checkAuth, (req, res) => {
    // checkAuth를 통과해야만 이 코드가 실행되어 admin.html 파일을 보여줍니다.
    res.sendFile(__dirname + '/public/admin.html');
});


// --- 기존 방문객 API ---

app.get('/visitors', checkAuth, async (req, res) => { // 방문객 목록 조회도 로그인해야만 가능
    try {
        const visitors = await Visitor.find().sort({ registeredAt: -1 });
        res.json(visitors);
    } catch (error) {
        res.status(500).json({ message: error.message });
    }
});

app.post('/register', async (req, res) => {
    // ... (등록 API는 로그인 없이 사용 가능하므로 그대로 둡니다) ...
    try {
        const newVisitor = new Visitor(req.body);
        const savedVisitor = await newVisitor.save();
        res.status(201).json(savedVisitor);
    } catch (error) {
        res.status(400).json({ message: error.message });
    }
});


app.listen(PORT, () => {
  console.log(`서버가 ${PORT}번 포트에서 실행 중입니다.`);
});