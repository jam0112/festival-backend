<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; max-width: 1000px; margin: 2rem auto; padding: 1rem; }
        h1 { text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
        th, td { border: 1px solid #ddd; padding: 0.8rem; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        a { text-decoration: none; color: #007bff; }
        .actions button { padding: 5px 10px; margin-right: 5px; cursor: pointer; border: 1px solid #ccc; border-radius: 4px; }
        .btn-edit { background-color: #ffc107; }
        .btn-delete { background-color: #dc3545; color: white; }
          .charts-container {
        display: flex;
        justify-content: space-around;
        margin-bottom: 2rem;
        gap: 1rem;
    }
    .charts-container > div {
        width: 30%; /* 45%ì—ì„œ 30%ë¡œ ìˆ˜ì • */
        padding: 1rem;
        border: 1px solid #ddd;
        border-radius: 8px;
    }
    </style>
</head>
<body>
    <h1>ğŸ“ ê´€ë¦¬ì í˜ì´ì§€: ë“±ë¡ì ëª…ë‹¨</h1>
<div class="charts-container">
        <div>
            <h2>ì„±ë³„ ë¶„í¬</h2>
            <canvas id="genderChart"></canvas>
        </div>
        <div>
            <h2>ì—°ë ¹ëŒ€ë³„ ë¶„í¬</h2>
            <canvas id="ageChart"></canvas>
        </div>
        <div>
            <h2>ìš”ì¼ë³„ ë“±ë¡ í˜„í™©</h2>
            <canvas id="dayChart"></canvas>
        </div>
        </div>
    <a href="/index.html"> &larr; ë“±ë¡ í˜ì´ì§€ë¡œ ëŒì•„ê°€ê¸°</a>
    <table>
        <thead>
            <tr>
                <th>ì´ë¦„</th>
                <th>ì—°ë½ì²˜</th>
                <th>ì„±ë³„</th>
                <th>ì—°ë ¹ëŒ€</th>
                <th>ì§€ì—­</th>
                <th>ë“±ë¡ì¼ì‹œ</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="visitorList">
            </tbody>
    </table>

<script>
    const API_URL = 'https://festival-backend-zika.onrender.com';
    const visitorList = document.getElementById('visitorList');

    // í˜ì´ì§€ê°€ ë¡œë“œë˜ë©´ ì‹¤í–‰
    window.onload = async () => {
        try {
            const response = await fetch(`${API_URL}/visitors`);
            if (!response.ok) throw new Error('ë°ì´í„° ë¡œë”© ì‹¤íŒ¨');
            const visitors = await response.json();
            
            // 1. ë°©ë¬¸ê° ëª…ë‹¨ í…Œì´ë¸” ë§Œë“¤ê¸°
            renderVisitorTable(visitors);

            // 2. ë°ì´í„° ë¶„ì„ ë° ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            createGenderChart(visitors);
            createAgeChart(visitors);
            createDayChart(visitors); // <-- ìš”ì¼ë³„ ì°¨íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ ì¶”ê°€

        } catch (error) {
            visitorList.innerHTML = `<tr><td colspan="7" style="text-align:center; color:red;">ì˜¤ë¥˜: ${error.message}</td></tr>`;
        }
    };

    // í…Œì´ë¸” ë Œë”ë§ í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼)
    function renderVisitorTable(visitors) {
        visitorList.innerHTML = ''; 
        if (visitors.length === 0) {
            visitorList.innerHTML = '<tr><td colspan="7" style="text-align:center;">ì•„ì§ ë“±ë¡ëœ ë°©ë¬¸ê°ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }
        visitors.forEach(visitor => {
            const row = document.createElement('tr');
            const registeredDate = new Date(visitor.registeredAt).toLocaleString('ko-KR');
            row.innerHTML = `
                <td>${visitor.name}</td>
                <td>${visitor.number}</td>
                <td>${visitor.gender}</td>
                <td>${visitor.age_group}</td>
                <td>${visitor.region}</td>
                <td>${registeredDate}</td>
                <td class="actions">
                    <button class="btn-edit" onclick="alert('ìˆ˜ì • ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •')">ìˆ˜ì •</button>
                    <button class="btn-delete" onclick="alert('ì‚­ì œ ê¸°ëŠ¥ êµ¬í˜„ ì˜ˆì •')">ì‚­ì œ</button>
                </td>
            `;
            visitorList.appendChild(row);
        });
    }

    // ì„±ë³„ ë¶„í¬ ì› ê·¸ë˜í”„ ìƒì„± í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼)
    function createGenderChart(visitors) {
        const ctx = document.getElementById('genderChart').getContext('2d');
        const genderCounts = visitors.reduce((acc, visitor) => {
            acc[visitor.gender] = (acc[visitor.gender] || 0) + 1;
            return acc;
        }, {});

        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: Object.keys(genderCounts),
                datasets: [{
                    data: Object.values(genderCounts),
                    backgroundColor: ['#36A2EB', '#FF6384', '#FFCE56'],
                }]
            }
        });
    }

    // ì—°ë ¹ëŒ€ë³„ ë¶„í¬ ë§‰ëŒ€ ê·¸ë˜í”„ ìƒì„± í•¨ìˆ˜ (ì´ì „ê³¼ ë™ì¼)
    function createAgeChart(visitors) {
        const ctx = document.getElementById('ageChart').getContext('2d');
        const ageGroups = ['10ëŒ€', '20ëŒ€', '30ëŒ€', '40ëŒ€', '50ëŒ€ ì´ìƒ'];
        const ageCounts = ageGroups.map(group => 
            visitors.filter(v => v.age_group === group).length
        );

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ageGroups,
                datasets: [{
                    label: 'ë°©ë¬¸ê° ìˆ˜',
                    data: ageCounts,
                    backgroundColor: '#4BC0C0',
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });
    }

    // â–¼â–¼â–¼ ì´ í•¨ìˆ˜ ì „ì²´ ì¶”ê°€ â–¼â–¼â–¼
    // ìš”ì¼ë³„ ë“±ë¡ í˜„í™© ë§‰ëŒ€ ê·¸ë˜í”„ ìƒì„± í•¨ìˆ˜
    function createDayChart(visitors) {
        const ctx = document.getElementById('dayChart').getContext('2d');
        const days = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const dayCounts = Array(7).fill(0); // [0, 0, 0, 0, 0, 0, 0] ë°°ì—´ ìƒì„±

        visitors.forEach(visitor => {
            const dayIndex = new Date(visitor.registeredAt).getDay(); // 0=ì¼ìš”ì¼, 1=ì›”ìš”ì¼...
            dayCounts[dayIndex]++;
        });

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: days,
                datasets: [{
                    label: 'ë“±ë¡ì ìˆ˜',
                    data: dayCounts,
                    backgroundColor: [
                        '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
                        '#9966FF', '#FF9F40', '#C9CBCF'
                    ],
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });
    }
    // â–²â–²â–² ì—¬ê¸°ê¹Œì§€ ì¶”ê°€ â–²â–²â–²
</script>
</body>
</html>